define(["jquery","WebUploader","bsm"],function(o,i){var t=Editor.toolbar,e=function(o,i){for(var e=0,a=t.length;a>e;e++){var r=t[e];if("string"!=typeof r&&r.name===o){r.action=i;break}}},a=o("body"),r=function(){var i=this;this.$win=o(['<div class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editorToolImageTitle" aria-hidden="true">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>','<h3 id="editorToolImageTitle">添加连接</h3>',"</div>",'<div class="modal-body">','<form class="form-horizontal">','<div class="control-group">','<label class="control-label">标题</label>','<div class="controls">','<input type="text" name="title" class="form-control" placeholder="Title">',"</div>","</div>",'<div class="control-group">','<label class="control-label">连接</label>','<div class="controls">','<input type="text" name="link" class="form-control" value="http://" placeholder="Link">',"</div>","</div>","</form>","</div>",'<div class="modal-footer">','<button class="btn btn-primary" role="save">确定</button>',"</div>","</div>"].join("")).appendTo(a),this.$win.on("click","[role=save]",function(){i.$win.find("form").submit()}).on("submit","form",function(){var t=o(this),e=t.find("[name=title]").val(),a=t.find("[name=link]").val();return i.$win.modal("hide"),i.editor.push(" ["+e+"]("+a+")"),t.find("[name=title]").val(""),t.find("[name=link]").val("http://"),!1})};r.prototype.bind=function(o){this.editor=o,this.$win.modal("show")};var l=function(){var t=this;this.$win=o(['<div class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editorToolImageTitle" aria-hidden="true">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>','<h3 id="editorToolImageTitle">图片</h3>',"</div>",'<div class="modal-body">','<div class="upload-img">','<div class="button btn btn-primary btn-addon btn-lg"><i class="fa fa-plus"></i>上传图片</div>','<span class="tip"></span>','<div class="alert alert-error hide"></div>',"</div>","</div>","</div>"].join("")).appendTo(a),this.$upload=this.$win.find(".upload-img").css({padding:"60px 0",textAlign:"center",border:"1px dashed#ddd"}),this.$uploadBtn=this.$upload.find(".button").css({position:"relative",margin:"0 auto"}),this.$uploadTip=this.$upload.find(".tip").hide(),this.file=!1,this.uploader=i.create({server:"/qnupload",pick:this.$uploadBtn[0],auto:!0,fileSingleSizeLimit:2097152,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},compress:{width:1070,quality:80,allowMagnify:!1,crop:!1}}),this.uploader.on("beforeFileQueued",function(o){return t.file===!1&&t.editor?void t.showFile(o):!1}),this.uploader.on("uploadProgress",function(o,i){t.showProgress(o,100*i)}),this.uploader.on("uploadSuccess",function(o,i){i.success?(t.$win.modal("hide"),t.editor.push(" !["+o.name+"]("+i.url+")")):(t.removeFile(),t.showError(i.msg||"服务器走神了，上传失败"))}),this.uploader.on("uploadComplete",function(o){t.uploader.removeFile(o),t.removeFile()}),this.uploader.on("error",function(o){switch(t.removeFile(),o){case"Q_EXCEED_SIZE_LIMIT":case"F_EXCEED_SIZE":t.showError("文件太大了, 不能超过2M");break;case"Q_TYPE_DENIED":t.showError("只能上传图片");break;default:t.showError("发生未知错误")}}),this.uploader.on("uploadError",function(){t.removeFile(),t.showError("服务器走神了，上传失败")})};l.prototype.removeFile=function(){this.file=!1,this.$uploadBtn.show(),this.$uploadTip.hide()},l.prototype.showFile=function(o){this.file=o,this.$uploadBtn.hide(),this.$uploadTip.html("正在上传: "+o.name).show(),this.hideError()},l.prototype.showError=function(o){this.$upload.find(".alert-error").html(o).show()},l.prototype.hideError=function(o){this.$upload.find(".alert-error").hide()},l.prototype.showProgress=function(o,i){this.$uploadTip.html("正在上传: "+o.name+" "+i+"%").show()},l.prototype.bind=function(o){this.editor=o,this.$win.modal("show")};var n=new l,d=new r;e("picture-o",function(o){n.bind(o)}),e("link",function(o){d.bind(o)});var s=Editor.prototype.createToolbar;Editor.prototype.createToolbar=function(i){s.call(this,i);var t=this;o(t.codemirror.display.input).on("focus",function(){n.editor=t})},Editor.prototype.push=function(o){var i=this.codemirror,t=i.lastLine();i.setLine(t,i.getLine(t)+o)}});