define(["jquery","WebUploader"],function(i,o){require(["bsm"]);var t=Editor.toolbar,e=function(i,o){for(var e=0,r=t.length;r>e;e++){var a=t[e];if("string"!=typeof a&&a.name===i){a.action=o;break}}},r=i("body"),a=function(){var o=this;this.$win=i(['<div class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editorToolImageTitle" aria-hidden="true">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>','<h3 id="editorToolImageTitle">添加连接</h3>',"</div>",'<div class="modal-body">','<form class="form-horizontal">','<div class="control-group">','<label class="control-label">标题</label>','<div class="controls">','<input type="text" name="title" class="form-control" placeholder="Title">',"</div>","</div>",'<div class="control-group">','<label class="control-label">连接</label>','<div class="controls">','<input type="text" name="link" class="form-control" value="http://" placeholder="Link">',"</div>","</div>","</form>","</div>",'<div class="modal-footer">','<button class="btn btn-primary" role="save">确定</button>',"</div>","</div>"].join("")).appendTo(r),this.$win.on("click","[role=save]",function(){o.$win.find("form").submit()}).on("submit","form",function(){var t=i(this),e=t.find("[name=title]").val(),r=t.find("[name=link]").val();return o.$win.modal("hide"),o.editor.push(" ["+e+"]("+r+")"),t.find("[name=title]").val(""),t.find("[name=link]").val("http://"),!1})};a.prototype.bind=function(i){this.editor=i,this.$win.modal("show")};var l=function(){var t=this;this.$win=i(['<div class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="editorToolImageTitle" aria-hidden="true">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>','<h3 id="editorToolImageTitle">图片</h3>',"</div>",'<div class="modal-body">','<div class="upload-img">','<div class="button btn btn-primary btn-addon btn-lg"><i class="fa fa-plus"></i>上传图片</div>','<span class="tip"></span>','<div class="alert alert-error hide"></div>',"</div>","</div>","</div>"].join("")).appendTo(r),this.$upload=this.$win.find(".upload-img").css({padding:"60px 0",textAlign:"center",border:"1px dashed#ddd"}),this.$uploadBtn=this.$upload.find(".button").css({position:"relative",margin:"0 auto"}),this.$uploadTip=this.$upload.find(".tip").hide(),this.file=!1,this.uploader=o.create({server:"/qnupload",pick:this.$uploadBtn[0],auto:!0,fileSingleSizeLimit:2097152,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},compress:{width:1070,quality:80,allowMagnify:!1,crop:!1}}),this.uploader.on("beforeFileQueued",function(i){return t.file===!1&&t.editor?void t.showFile(i):!1}),this.uploader.on("uploadProgress",function(i,o){t.showProgress(i,100*o)}),this.uploader.on("uploadSuccess",function(i,o){o.success?(t.$win.modal("hide"),t.editor.push(" !["+i.name+"]("+o.url+")")):(t.removeFile(),t.showError(o.msg||"服务器走神了，上传失败"))}),this.uploader.on("uploadComplete",function(i){t.uploader.removeFile(i),t.removeFile()}),this.uploader.on("error",function(i){switch(t.removeFile(),i){case"Q_EXCEED_SIZE_LIMIT":case"F_EXCEED_SIZE":t.showError("文件太大了, 不能超过2M");break;case"Q_TYPE_DENIED":t.showError("只能上传图片");break;default:t.showError("发生未知错误")}}),this.uploader.on("uploadError",function(){t.removeFile(),t.showError("服务器走神了，上传失败")})};l.prototype.removeFile=function(){this.file=!1,this.$uploadBtn.show(),this.$uploadTip.hide()},l.prototype.showFile=function(i){this.file=i,this.$uploadBtn.hide(),this.$uploadTip.html("正在上传: "+i.name).show(),this.hideError()},l.prototype.showError=function(i){this.$upload.find(".alert-error").html(i).show()},l.prototype.hideError=function(i){this.$upload.find(".alert-error").hide()},l.prototype.showProgress=function(i,o){this.$uploadTip.html("正在上传: "+i.name+" "+o+"%").show()},l.prototype.bind=function(i){this.editor=i,this.$win.modal("show")};var n=new l,d=new a;e("picture-o",function(i){n.bind(i)}),e("link",function(i){d.bind(i)});var s=Editor.prototype.createToolbar;Editor.prototype.createToolbar=function(o){s.call(this,o);var t=this;i(t.codemirror.display.input).on("focus",function(){n.editor=t})},Editor.prototype.push=function(i){var o=this.codemirror,t=o.lastLine();o.setLine(t,o.getLine(t)+i)}});